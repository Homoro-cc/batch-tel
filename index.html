<script>
  const powerSwitch = document.getElementById('powerSwitch');
  const cards = document.querySelectorAll('.ad-card');

  powerSwitch.checked = false;

  function sleep(ms){ return new Promise(resolve=>setTimeout(resolve,ms)); }

  function setupCard(card) {
    const btn = card.querySelector('.btn');
    const adsLoadedSpan = card.querySelector('.adsLoaded');
    const btnClickedSpan = card.querySelector('.btnClicked');
    const adLink = btn.dataset.link;
    const cardSwitch = card.querySelector('.cardSwitch');
    let adsLoadedCount = 0;
    let btnClickedCount = 0;

    async function loadAd() {
      if (!powerSwitch.checked || !cardSwitch.checked) {
        btn.disabled = true;
        btn.style.display = 'none';
        if (!card.querySelector('.ad-off-message')) {
          const msg = document.createElement('div');
          msg.className = 'ad-off-message';
          msg.textContent = 'Div is Off';
          card.appendChild(msg);
        }
        return;
      }

      const offMsg = card.querySelector('.ad-off-message');
      if (offMsg) offMsg.remove();

      btn.style.display = 'block';
      btn.disabled = true;
      btn.textContent = 'AD is Loading...';

      await sleep(3000); // Simulate ad loading

      if (!powerSwitch.checked || !cardSwitch.checked) return;

      adsLoadedCount++;
      adsLoadedSpan.textContent = adsLoadedCount;
      btn.disabled = false;
      btn.textContent = 'Click to Open Ad';
    }

    btn.addEventListener('click', async () => {
      btnClickedCount++;
      btnClickedSpan.textContent = btnClickedCount;

      // Open ad in a new tab
      window.open(adLink, '_blank');

      btn.disabled = true;
      btn.textContent = 'Watching Ad...';

      // Wait few seconds, then redirect main page
      await sleep(5000);

      btn.textContent = 'Redirecting...';
      await sleep(1000);

      // Example: redirect to direct link after ad
      window.location.href = adLink; // You can change this to your final direct link
    });

    cardSwitch.addEventListener('change', ()=>{ loadAd(); });

    async function autoClick() {
      if (powerSwitch.checked && cardSwitch.checked) {
        await loadAd();
        if(!btn.disabled){ btn.click(); }
      }
    }

    return { loadAd, autoClick };
  }

  const cardControllers = Array.from(cards).map(setupCard);

  powerSwitch.addEventListener('change', async ()=>{
    cards.forEach(card=>{
      const cs = card.querySelector('.cardSwitch');
      cs.checked = powerSwitch.checked;
    });

    if (powerSwitch.checked) {
      for (let i=0; i<cardControllers.length; i++) {
        await cardControllers[i].autoClick();
      }
    } else {
      cards.forEach(card=>{
        const offMsg = card.querySelector('.ad-off-message');
        if (!offMsg) {
          const msg = document.createElement('div');
          msg.className='ad-off-message';
          msg.textContent='Div is Off';
          card.appendChild(msg);
        }
      });
    }
  });
</script>